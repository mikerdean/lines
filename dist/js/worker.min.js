function CsvParser(){if(!(this instanceof CsvParser))return new CsvParser;this.separator=","}function TsvParser(){if(!(this instanceof TsvParser))return new TsvParser;this.separator="\t"}function PatternParser(r){if(!(this instanceof PatternParser))return new PatternParser(r);if(!r)throw new Error("Please provide a pattern.");this.processor=PatternParser.createProcessor(r)}CsvParser.prototype.parse=function(r,e){for(var t,n,a=[],o=e,s=[],i=!1,u=0,f=0,c=0;c<r.length;c+=1)t=r[c],n=r[c+1],o||s.hasOwnProperty(u)||(s[u]=[]),o||s[u].hasOwnProperty(f)||(s[u][f]=""),o&&!a.hasOwnProperty(f)&&(a[f]=""),'"'===t&&i&&'"'===n?(o?a[f]+=t:s[u][f]+=t,c+=1):'"'===t?i=!i:t!==this.separator||i?"\r"!==t||"\n"!==n||i?"\n"!==t&&"\r"!==t||i?o?a[f]+=t.toLowerCase():s[u][f]+=t:(u+=o?0:1,f=0,o=!1):(u+=o?0:1,f=0,c+=1,o=!1):f+=1;return{headers:a,rows:s}},TsvParser.prototype.parse=function(r,e){for(var t,n,a=[],o=e,s=[],i=0,u=0,f=0;f<r.length;f+=1)t=r[f],n=r[f+1],o||s.hasOwnProperty(i)||(s[i]=[]),o||s[i].hasOwnProperty(u)||(s[i][u]=""),o&&!a.hasOwnProperty(u)&&(a[u]=""),t===this.separator?u+=1:"\r"===t&&"\n"===n?(i+=o?0:1,u=0,f+=1,o=!1):"\n"===t||"\r"===t?(i+=o?0:1,u=0,o=!1):o?a[u]+=t.toLowerCase():s[i][u]+=t;return{headers:a,rows:s}},PatternParser.fn={backtick:function(r){return"`"+r+"`"},guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){var e=16*Math.random()|0;return("x"===r?e:3&e|8).toString(16)})},indexOf:function(r,e){return r.indexOf(e)},lastIndexOf:function(r,e){return r.lastIndexOf(e)},lower:function(r){return r.toLowerCase()},quote:function(r){return'"'+r+'"'},replace:function(r,e,t){return r.replace(new RegExp(e),t)},random:function(r,e){return r=Math.ceil(r),e=Math.floor(e),Math.floor(Math.random()*(e-r+1))+r},reverse:function(r){for(var e="",t=r.length-1;-1<t;t-=1)e+=r[t];return e},single:function(r){return"'"+r+"'"},slice:function(r,e,t){return r.slice(e,t)},substring:function(r,e,t){return r.substr(e,t)},title:function(r){return r.replace(/\b(\w+)\b/g,function(r){return r[0].toUpperCase()+r.slice(1).toLowerCase()})},trim:function(r){return String.prototype.trim?r.trim():this.replace(/^\s+/,"").replace(/\s+$/,"")},trimLeft:function(r){return String.prototype.trimLeft?r.trimLeft():String.prototype.trimStart?r.trimStart():this.replace(/^\s+/,"")},trimRight:function(r){return String.prototype.trimRight?r.trimRight():String.prototype.trimEnd?r.trimEnd():this.replace(/\s+$/,"")},upper:function(r){return r.toUpperCase()},urlDecode:function(r){return decodeURI(r)},urlDecodeComponent:function(r){return decodeURIComponent(r)},urlEncode:function(r){return encodeURI(r)},urlEncodeComponent:function(r){return encodeURIComponent(r)}},PatternParser.allowedDigits=["0","1","2","3","4","5","6","7","8","9"],PatternParser.parseInt=function(r){for(var e=0;e<r.length;e+=1){var t=r[e];if((0!==e||"-"!==t&&"+"!==t)&&-1===PatternParser.allowedDigits.indexOf(t))return NaN}return parseInt(r,10)},PatternParser.parseFloat=function(r){for(var e=!1,t=0;t<r.length;t+=1){var n=r[t];if(0!==t||"-"!==n&&"+"!==n)if("."!==n||e){if("."===n&&e)return NaN;if(-1===PatternParser.allowedDigits.indexOf(n))return NaN}else e=!0}return parseFloat(r)},PatternParser.createProcessor=function(r){for(var e,t,s=[],n=0,a=!1,i="",u="",f=[],o="",c=!1,p="",l=function(){var r=o.slice(0);s.push(function(){return r}),o=""},P=0;P<r.length;P+=1)e=r[P],t=r[P+1],"$"===e&&"("===t?(P+=1,n+=1,a?u+="$(":(c=!0,l())):"@"===e?a?u+="@":(a=!0,l()):a&&"("===e?1<(n+=1)&&(u+="("):a&&0<n&&","===e?(f.push(u.slice(0)),u=""):")"===e&&1===n&&c&&!a?(function(){var n=p.slice(0).toLowerCase(),t=PatternParser.parseInt(n);isNaN(t)?s.push(function(r,e){var t=r.indexOf(n);return 0<=t?e[t]:"ERR"}):s.push(function(r,e){return e[t]})}(),n-=1,c=!1,p=""):c&&!a?p+=e:")"===e&&1<n?(n-=1,a&&(u+=")")):")"===e&&1===n&&a?(0<f.length&&f.push(u.slice(0)),PatternParser.fn.hasOwnProperty(i)?function(){var t,a=PatternParser.fn[i],o=[];if(0<f.length){for(var r=0;r<f.length;r+=1)o.push(PatternParser.createProcessor(f[r].slice(0)));s.push(function(r,e){for(var t=[],n=0;n<o.length;n+=1)t.push(o[n](r,e));return a.apply(null,t)})}else t=PatternParser.createProcessor(u),s.push(function(r,e){return a(t(r,e))})}():s.push(function(){return"ERR"}),n-=1,a=!1,f=[],u=i=""):a&&0<n?u+=e:a?i+=e:o+=e;return 0<o.length&&l(),function(r,e){for(var t="",n=0;n<s.length;n+=1){t+=(0,s[n])(r,e)}return t}},PatternParser.prototype.format=function(r,e,t){for(var n="",a=this.processor,o=0;o<e.length;o+=1)n+=a(r,e[o])+t;return n},onmessage=function(r){var e=r.data;if(!e.pattern||!e.lines)return postMessage(void 0);var t=("tsv"===e.separator?new TsvParser:new CsvParser).parse(e.lines,e.headers),n=new PatternParser(e.pattern).format(t.headers,t.rows,"\n");return postMessage({headers:e.headers,results:n})};